{% block rizeway_jqueryui_autocompleter_widget %}
    {{ block('hidden_widget') }}

    {% set id = 'autocompleter_' ~ id %}
    {{ block('field_widget') }}
    
    <script>
        jQuery(document).ready(function() {
            
            function rizeway_split( val ) {
                return val.split( /,\s*/ );
            }
            function rizeway_extractLast( term ) {
                return rizeway_split( term ).pop();
            }
            
            $( '#{{ id }}' )
                // don't navigate away from the field on tab when selecting an item
                .bind( "keydown", function( event ) {
                        if ( event.keyCode === $.ui.keyCode.TAB &&
                                        $( this ).data( "autocomplete" ).menu.active ) {
                                event.preventDefault();
                        }
                })
                .autocomplete({
                        minLength: 1,

                        source: function( request, response ) {
                                $.getJSON( "{{url}}", {
                                        term: rizeway_extractLast( request.term )
                                }, response );
                        },
                        search: function() {
                                // custom minLength
                                var term = rizeway_extractLast( this.value );
                                if ( term.length < 2 ) {
                                        return false;
                                }
                        },
                        focus: function() {
                                // prevent value inserted on focus
                                return false;
                        },
                        select: function( event, ui ) {
                                var terms = rizeway_split( this.value );
                                // remove the current input
                                terms.pop();
                                // add the selected item
                                terms.push( ui.item.value );
                                // add placeholder to get the comma-and-space at the end
                                terms.push( "" );
                                this.value = terms.join( ", " );
                                return false;
                        }
                });
            
        });
    </script>
{% endblock rizeway_jqueryui_autocompleter_widget %}

{% block rizeway_smarttextbox_autocompleter_widget %}
    {% set id = 'autocompleter_' ~ id %}
    {{ block('field_widget') }}
    <script>
        jQuery(document).ready(function() {
            $("#{{id}}").smartTextBox({
                autocomplete: true,
                separator: ',',
                autocompleteUrl: '{{url}}',
                maxResults: 10
            });    
        });
    </script>
{% endblock rizeway_smarttextbox_autocompleter_widget %}